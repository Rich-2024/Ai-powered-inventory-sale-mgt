@extends('layouts.app')

@section('content')
<div class="max-w-5xl mx-auto p-6 bg-white rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Upload Inventory</h1>

    @if(session('success'))
        <div class="mb-6 p-4 bg-green-100 text-green-800 rounded border border-green-300">
            {{ session('success') }}
        </div>
    @endif

    <form method="POST" action="{{ route('inventory.upload.process') }}">
        @csrf

        <div id="products-container" class="space-y-6">
            <div class="product-item grid grid-cols-12 gap-4 items-start border rounded p-5 bg-gray-50 shadow-sm" data-index="0">
                {{-- SKU --}}
                <div class="col-span-12 sm:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">SKU</label>
                    <div class="flex space-x-2">
                        <input type="text" name="products[0][sku]" class="sku-input w-full border-gray-300 rounded px-3 py-2" required>
                        <button type="button" class="scan-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded" title="Scan Barcode">ðŸ“·</button>
                    </div>
                </div>

                {{-- Name --}}
                <div class="col-span-12 sm:col-span-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                    <input type="text" name="products[0][name]" required class="w-full border-gray-300 rounded px-3 py-2">
                </div>

                {{-- Quantity --}}
                <div class="col-span-6 sm:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                    <input type="number" name="products[0][quantity]" class="quantity-input w-full border-gray-300 rounded px-3 py-2" min="1" required>
                </div>

                {{-- Unit --}}
                <div class="col-span-6 sm:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                    <select name="products[0][unit]" class="unit-select w-full border-gray-300 rounded px-3 py-2">
                        <option value="piece" selected>Piece</option>
                        <option value="dozen">Dozen</option>
                        <option value="carton">Carton</option>
                    </select>
                </div>

                {{-- Bulk Purchase --}}
                <div class="col-span-6 sm:col-span-3 bulk-group hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bulk Purchase Price</label>
                    <input type="text" name="products[0][purchase_price_bulk]" class="bulk-purchase number-input w-full border-gray-300 rounded px-3 py-2" placeholder="e.g. 1,200.00">
                </div>

                {{-- Bulk Selling --}}
                <div class="col-span-6 sm:col-span-3 bulk-group hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Bulk Selling Price</label>
                    <input type="text" name="products[0][selling_price_bulk]" class="bulk-sell number-input w-full border-gray-300 rounded px-3 py-2" placeholder="e.g. 1,500.00">
                </div>

                {{-- Per-piece Purchase --}}
                <div class="col-span-6 sm:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Purchase Price (per piece)</label>
                    <input type="text" name="products[0][purchase_price]" readonly class="per-piece-purchase w-full bg-gray-100 border-gray-300 rounded px-3 py-2 text-gray-600">
                </div>

                {{-- Per-piece Sell --}}
                <div class="col-span-6 sm:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Selling Price (per piece)</label>
                    <input type="text" name="products[0][price]" readonly class="per-piece-sell w-full bg-gray-100 border-gray-300 rounded px-3 py-2 text-gray-600">
                </div>

                {{-- Remove --}}
                <div class="col-span-12 sm:col-span-1 flex justify-end pt-6">
                    <button type="button" class="remove-product bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded" disabled>&times;</button>
                </div>
            </div>
        </div>

        <div class="mt-6 flex justify-between">
            <button type="button" id="add-product" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow">+ Add Another Product</button>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-2 rounded shadow">Upload Inventory</button>
        </div>
    </form>
</div>

{{-- Barcode Scanner Modal --}}
<div id="scanner-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg relative max-w-md w-full">
        <video id="barcode-video" class="w-full h-64 border rounded" autoplay></video>
        <button id="close-scanner" class="absolute top-2 right-2 text-xl text-gray-600 hover:text-black">&times;</button>
        <p class="text-sm text-gray-500 mt-2">Point your camera at the barcode</p>
        <p id="scanner-feedback" class="text-sm text-red-600 mt-2 h-5"></p>
    </div>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
    const parseNumber = val => parseFloat(val.replace(/,/g, '')) || 0;
    const formatNumber = val => new Intl.NumberFormat().format(parseFloat(val).toFixed(2));

    let productIndex = 1;
    let scannerActive = false;
    let selectedSkuInput = null;
    const codeReader = new ZXing.BrowserBarcodeReader();

    function updatePerPiecePrices(container) {
        const qty = parseNumber(container.querySelector('.quantity-input')?.value || '0');
        const bulkPurchase = parseNumber(container.querySelector('.bulk-purchase')?.value || '0');
        const bulkSell = parseNumber(container.querySelector('.bulk-sell')?.value || '0');

        const perPurchase = qty > 0 ? bulkPurchase / qty : 0;
        const perSell = qty > 0 ? bulkSell / qty : 0;

        container.querySelector('.per-piece-purchase').value = perPurchase ? formatNumber(perPurchase) : '';
        container.querySelector('.per-piece-sell').value = perSell ? formatNumber(perSell) : '';
    }

    function toggleBulkFields(container) {
        const unit = container.querySelector('.unit-select').value;
        const bulkGroups = container.querySelectorAll('.bulk-group');
        bulkGroups.forEach(group => group.classList.toggle('hidden', unit === 'piece'));
    }

    function bindProductEvents(container) {
        const unitSelect = container.querySelector('.unit-select');
        const bulkInputs = container.querySelectorAll('.bulk-purchase, .bulk-sell');
        const quantityInput = container.querySelector('.quantity-input');
        const skuInput = container.querySelector('.sku-input');
        const scanBtn = container.querySelector('.scan-btn');

        unitSelect.addEventListener('change', () => {
            toggleBulkFields(container);
            updatePerPiecePrices(container);
        });

        bulkInputs.forEach(input => {
            input.addEventListener('input', () => {
                let raw = input.value.replace(/[^0-9.]/g, '');
                const parts = raw.split('.');
                if (parts.length > 2) raw = parts[0] + '.' + parts[1];
                input.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                updatePerPiecePrices(container);
            });
        });

        quantityInput.addEventListener('input', () => updatePerPiecePrices(container));

        scanBtn.addEventListener('click', () => {
            selectedSkuInput = skuInput;
            document.getElementById('scanner-modal').classList.remove('hidden');
            startScanner();
        });

        container.querySelector('.remove-product').addEventListener('click', () => container.remove());

        toggleBulkFields(container);
        updatePerPiecePrices(container);
    }

    document.getElementById('add-product').addEventListener('click', () => {
        const template = document.querySelector('.product-item');
        const clone = template.cloneNode(true);
        clone.setAttribute('data-index', productIndex);

        clone.querySelectorAll('input, select').forEach(input => {
            const name = input.getAttribute('name');
            if (name) input.setAttribute('name', name.replace(/\[\d+]/, `[${productIndex}]`));
            if (!input.classList.contains('unit-select')) input.value = '';
            input.disabled = false;
        });

        document.getElementById('products-container').appendChild(clone);
        bindProductEvents(clone);
        productIndex++;
    });

    // Barcode scanner
    function startScanner() {
        if (scannerActive) return;
        scannerActive = true;
        codeReader.decodeFromConstraints({ video: { facingMode: "environment" } }, 'barcode-video', handleScan)
            .catch(() => {
                codeReader.decodeFromVideoDevice(null, 'barcode-video', handleScan)
                    .catch(err => {
                        document.getElementById('scanner-feedback').textContent = "Camera error: " + err.message;
                        stopScanner();
                    });
            });
    }

    function handleScan(result, err) {
        if (result) {
            codeReader.reset();
            scannerActive = false;
            document.getElementById('scanner-modal').classList.add('hidden');
            if (selectedSkuInput) {
                selectedSkuInput.value = result.text;
                selectedSkuInput.focus();
            }
            new Audio('/sounds/beep.mp3').play().catch(() => {});
        } else if (err && !(err instanceof ZXing.NotFoundException)) {
            document.getElementById('scanner-feedback').textContent = 'Error: ' + err.message;
        } else {
            document.getElementById('scanner-feedback').textContent = 'Scanning...';
        }
    }

    function stopScanner() {
        if (!scannerActive) return;
        codeReader.reset();
        scannerActive = false;
        document.getElementById('scanner-modal').classList.add('hidden');
        document.getElementById('scanner-feedback').textContent = '';
    }

    document.getElementById('close-scanner').addEventListener('click', stopScanner);

    // Initial bind
    document.querySelectorAll('.product-item').forEach(container => bindProductEvents(container));
</script>
@endsection
